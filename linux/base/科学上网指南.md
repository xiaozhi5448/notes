# 科学上网指南

### 认识并安装shadowsocks

----

```shell
sudo yum install python-pip
sudo pip install shadowsocks
```

两条命令执行完成后，会安装ssserver与sslocal两个工具，ssserver运行在服务端，sslocal运行在客户端，服务端配置文件如下

```json
{  
    "server":"my ip",  
    "server_port":myport,  
    "local_port":1080,  
    "password":"my password",  
    "timeout":600,  
    "method":"aes-256-cfb"  
}
## 如果指定多个端口运行
"port_password":{
    "port":"password",
    "port2":"password"
}
```

随后在服务端执行ssserver

```shell
ssserver -c config.json -d start #也可以在命令行直接指定运行参数
```

客户端配置文件

```json
{
    "server":"123.207.251.52",
    "server_port":23456,
    "local_port":1080
    "password":"w158en239",
    "method":"aes-256-cfb",
    "remarks":""
}
```

在客户端执行

```shell
sslocal -c config.json -d start
```

可以看到sslocal监听在本机1080端口

```shell
$ netstat -tnlp | grep 1080
(Not all processes could be identified, non-owned process info
 will not be shown, you would have to be root to see it all.)
tcp        0      0 127.0.0.1:1080          0.0.0.0:*               LISTEN      -    
```

在google浏览器中使用switchomega插件，设置google代理后，可以通过google浏览器访问外网

可以编写一条命令脚本放入/etc/init.d/目录下，实现开机自启动

```shell
$ cat /etc/init.d/sslocal 
#!/bin/bash
sudo sslocal -c /home/xiaozhi/config/tengxunyun.json -b 0.0.0.0 -d start
```

### 在服务端启用bbr

升级centos内核

```shell
rpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org
rpm -Uvh http://www.elrepo.org/elrepo-release-7.0-3.el7.elrepo.noarch.rpm
yum -y --enablerepo=elrepo-kernel install kernel-ml
grub2-set-default 0
reboot
uname -r
```

在sysctl.conf中添加

```shell
net.core.default_qdisc = fq
net.ipv4.tcp_congestion_control = bbr
```

使用sysctl -p加载配置

### 使用proxychains代理终端网络请求

----

安装proxychains，在deepin中可以直接通过aptget进行安装，而在centos中要通过github源码编译安装，安装完成后，在/etc/目录下拷贝一份配置文件，在配置文件的最后一行添加socks代理

```shell
socks5  127.0.0.1	1080 # 配置文件中有用例说明
```

使用时，在需要使用代理的命令前，加上proxychains即可， 如

```shell
proxychains curl www.google.com
```



### 使用privoxy将socks代理转变为http代理

----

privoxy直接使用apt命令安装即可，如果软件源中没有，也可以获取github源码后自己编译安装。安装完成后默认配置文件位于

/etc/privoxy/config，编辑该文件，加入如下内容

```shell
forward-socks5	/	127.0.0.1:1080	. # socks代理地址
listen-address 127.0.0.1:8118   # 本地监听地址
forward 192.168.*.*/	.   # 私有IP地址直连
forward 127.*.*.*/	.        # 私有IP地址直连
```

在使用http代理时，可以设置http_proxy环境变量，但是每次使用都设置环境变量有些麻烦，而且设置环境变量以后整个bash执行环境的http代理都会变为本地的privoxy，有些不方便。像proxychains那样使用privoxy，需要我们自己编写脚本解决，但是没关系，一句话就可以解决

```shell
http_proxy='http://127.0.0.1:8118' https_proxy='http://127.0.0.1:8118' $*
```

将其放入脚本文件中，比如ssproxy.sh，随后在/usr/bin/目录下创建该文件的软连接，添加可执行权限，使用的时候就可以向proxychains一样了（命令中的$*，代表将此脚本的所有参数当做命令执行）

```shell
ssproxy curl www.google.com
```

privoxy采用软件包管理工具安装的话，会自动在/etc/init.d安装启动脚本，实现开机自启动，无需认为干预



### 使用genpac生成pac文件实现国内直连，国外代理

----

genpac是一个用于将gfwlist转换为pac文件的python小工具，可以通过pip安装

```shell
pip install genpac --user
```

可以使用如下命令生成pac文件

```shell
genpac -p "SOCKS5 127.0.0.1:1080" --gfwlist-proxy="SOCKS5 127.0.0.1:1080" --gfwlist-url=https://raw.githubusercontent.com/gfwlist/gfwlist/master/gfwlist.txt --output="config/autoproxy.pac"
```

在firefox浏览器中设置自动代理，指定pac文件的位置即可

```shell
file:///home/xiaozhi/config/autoproxy.pac
```

也可以在系统代理中选择自动代理，同样的设置pac文件的位置，在浏览器代理中选择系统代理

除此之外，在github上有前辈维护的gfw列表，可以根据此列表设置switchyomega规则，实现动态代理

### ss服务器被封禁，使用socat做端口转发

----

### 使用stunnel建立加密隧道

生成证书

```shell
openssl req -new -x509 -days 365 -nodes -out stunnel.pem -keyout stunnel.pem
```

serverconf

```
key=stunnel.pem
client=no
output=stunnel.log
[23450]
accept=23550
connect=127.0.0.1:23450
```

clientconf

```
cert=stunnel.pem
key=stunnel.pem
client=yes
output=stunnel.log
[23450]
accept=23450
connect=server:23550

```

genconf

```shell
arr=$(seq 23550 23565)
for port in $arr
do
    port2=$(expr $port - 100)
    echo -e "[${port2}]"
    echo -e "accept=$port"
    echo -e "connect=127.0.0.1:${port2}"
done
```

### ipsec

```
docker pull hwdsl2/ipsec-vpn-server
```

vpn.env

```
VPN_IPSEC_PSK=your_ipsec_pre_shared_key
VPN_USER=your_vpn_username
VPN_PASSWORD=your_vpn_password
```

start container

```shell
docker run \
    --name ipsec-vpn-server \
    --env-file ./vpn.env \
    --restart=always \
    -p 500:500/udp \
    -p 4500:4500/udp \
    -v /lib/modules:/lib/modules:ro \
    -d --privileged \
    hwdsl2/ipsec-vpn-server
```

scan

```shell
#!/bin/bash

# Encryption algorithms: 3des=5, aes128=7/128, aes192=7/192, aes256=7/256
ENCLIST="5 7/128 7/192 7/256"
# Hash algorithms: md5=1, sha1=2, sha256=5, sha384=6, sha512=7
HASHLIST="1 2 5 6 7"
# Diffie-Hellman groups: 1, 2, 5, 14, 15, 19, 20, 21
GROUPLIST="1 2 5 14 15 19 20 21"
# Authentication method: Preshared Key=1
AUTH=1

for ENC in $ENCLIST; do
   for HASH in $HASHLIST; do
       for GROUP in $GROUPLIST; do
          echo ike-scan --trans=$ENC,$HASH,$AUTH,$GROUP -M "$@"
          ike-scan -s 0 --trans=$ENC,$HASH,$AUTH,$GROUP -M "$@"
      done
   done
done

```

```
bash scan.sh | grep SA
```

