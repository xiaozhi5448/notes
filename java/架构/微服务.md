# 微服务架构

## 为什么引入微服务

## 服务拆分

## 注册与发现

## RPC远程调用

负载均衡

## 消息队列

## 微服务网关

## 业务相关的分布式课题

### 分布式ID

在复杂分布式系统中，往往需要对大量的数据和消息进行唯一标识。如在美团点评的 金融、支付、餐饮、酒店、猫眼电影等产品的系统中，数据日渐增长，对数据分库分 表后需要有一个唯一ID来标识一条数据或消息，数据库的自增ID显然不能满足需求； 特别一点的如订单、骑手、优惠券也都需要有唯一ID做标识。此时一个能够生成全局 唯一ID的系统是非常必要的。概括下来，那业务系统对ID号的要求有哪些呢？

- 全局唯一性：不能出现重复的ID号，既然是唯一标识，这是最基本的要求。
-  趋势递增：在MySQL InnoDB引擎中使用的是聚集索引，由于多数RDBMS使用B-tree的 数据结构来存储索引数据，在主键的选择上面我们应该尽量使用有序的主键保证写入性能。 
-  单调递增：保证下一个ID一定大于上一个ID，例如事务版本号、IM增量消息、排序等特殊需求。
- 信息安全：如果ID是连续的，恶意用户的扒取工作就非常容易做了，直接按照顺序下载 指定URL即可；如果是订单号就更危险了，竞对可以直接知道我们一天的单量。所以在一些 应用场景下，会需要ID无规则、不规则。 

上述123对应三类不同的场景，3和4需求还是互斥的，无法使用同一个方案满足。 同时除了对ID号码自身的要求，业务还对ID号生成系统的可用性要求极高，想象一 下，如果ID生成系统瘫痪，整个美团点评支付、优惠券发券、骑手派单等关键动作都 无法执行，这就会带来一场灾难。 

#### UUID

UUID(Universally Unique Identifier)的标准型式包含32个16进制数字，以连字号分 为五段，形式为8-4-4-4-12的36个字符，示例：550e8400-e29b-41d4-a716- 446655440000。使用UUID没有网络资源消耗，本地生成，性能优秀，但是由于其随机特性，完全无序，且数据过长，不适合当做数据库主键。

```java
UUID.randomUUID()
```

#### snowflake

这种方案大致来说是一种以划分命名空间（UUID也算，由于比较常见，所以单独分 析）来生成ID的一种算法，这种方案把64-bit分别划分成多段，分开来标示机器、时间等

![image-20220704213632454](%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220704213632454.png)

理论上snowflake方 案的QPS约为409.6w/s，这种分配方式可以保证在任何一个IDC的任何一台机器在任 意毫秒内生成的ID都是不同的。

snowflake方案具有如下优势：

- 毫秒数在高位，自增序列在低位，整个ID都是趋势递增的
- 不依赖数据库等第三方系统，以服务的方式部署，稳定性更高，生成ID的性能也是非常高的。
- 可以根据自身业务特性分配bit位，非常灵活。

但是该方案会有互联网机器时钟回拨导致的ID服务不可用的问题。时钟回拨指的是当前主机的时间比互联网时间快，在与时间服务器同步之后，时间被设置为正确的值（因为当前时钟太快了，所以要往回拨）。时钟回拨之后雪花算法可能会生成相同的ID，不满足全局唯一性。

#### 数据库自增主键

##### 号段模式

##### 双buffer优化

#### Leaf-snowflake

#### UidGenerator

#### TinyID

#### Butterfly



### 分布式事务

### 分布式SESSION

### 分布式锁

### 分布式数据库

### 高可用

限流

熔断

降级

排队

集群

超时重传

异地灾备与多活





